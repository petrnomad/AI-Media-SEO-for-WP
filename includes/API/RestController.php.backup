<?php
/**
 * REST API Controller
 *
 * Handles all REST API endpoints for the plugin.
 *
 * @package    AIMediaSEO
 * @subpackage API
 * @since      1.0.0
 */

namespace AIMediaSEO\API;

use AIMediaSEO\Analyzer\ImageAnalyzer;
use AIMediaSEO\Providers\OpenAIProvider;
use AIMediaSEO\Storage\MetadataStore;
use WP_REST_Controller;
use WP_REST_Server;
use WP_REST_Request;
use WP_REST_Response;
use WP_Error;

/**
 * RestController class.
 *
 * Provides REST API endpoints for AI Media SEO operations.
 *
 * @since 1.0.0
 */
class RestController extends WP_REST_Controller {

	/**
	 * Namespace.
	 *
	 * @var string
	 */
	protected $namespace = 'ai-media/v1';

	/**
	 * Metadata store.
	 *
	 * @var MetadataStore
	 */
	private $metadata_store;

	/**
	 * Language detector.
	 *
	 * @var \AIMediaSEO\Multilingual\LanguageDetector
	 */
	private $language_detector;

	/**
	 * Constructor.
	 *
	 * @since 1.0.0
	 */
	public function __construct() {
		$this->metadata_store    = new MetadataStore();
		$this->language_detector = new \AIMediaSEO\Multilingual\LanguageDetector();
	}

	/**
	 * Register routes.
	 *
	 * @since 1.0.0
	 */
	public function register_routes(): void {
		// Register post meta for status field.
		register_post_meta(
			'attachment',
			'_ai_media_status',
			array(
				'type'         => 'string',
				'single'       => true,
				'show_in_rest' => true,
				'default'      => 'pending',
			)
		);

		// Analyze images.
		register_rest_route(
			$this->namespace,
			'/analyze',
			array(
				array(
					'methods'             => WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'analyze_images' ),
					'permission_callback' => array( $this, 'check_analyze_permission' ),
					'args'                => $this->get_analyze_args(),
				),
			)
		);

		// Approve metadata.
		register_rest_route(
			$this->namespace,
			'/approve',
			array(
				array(
					'methods'             => WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'approve_metadata' ),
					'permission_callback' => array( $this, 'check_approve_permission' ),
					'args'                => $this->get_approve_args(),
				),
			)
		);

		// Get jobs.
		register_rest_route(
			$this->namespace,
			'/jobs',
			array(
				array(
					'methods'             => WP_REST_Server::READABLE,
					'callback'            => array( $this, 'get_jobs' ),
					'permission_callback' => array( $this, 'check_read_permission' ),
					'args'                => $this->get_jobs_args(),
				),
			)
		);

		// Get stats.
		register_rest_route(
			$this->namespace,
			'/stats',
			array(
				array(
					'methods'             => WP_REST_Server::READABLE,
					'callback'            => array( $this, 'get_stats' ),
					'permission_callback' => array( $this, 'check_read_permission' ),
				),
			)
		);

		// Regenerate metadata.
		register_rest_route(
			$this->namespace,
			'/regenerate',
			array(
				array(
					'methods'             => WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'regenerate_metadata' ),
					'permission_callback' => array( $this, 'check_analyze_permission' ),
					'args'                => $this->get_regenerate_args(),
				),
			)
		);

		// Batch analyze.
		register_rest_route(
			$this->namespace,
			'/batch-analyze',
			array(
				array(
					'methods'             => WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'batch_analyze' ),
					'permission_callback' => array( $this, 'check_analyze_permission' ),
					'args'                => $this->get_batch_analyze_args(),
				),
			)
		);

		// Update image status.
		register_rest_route(
			$this->namespace,
			'/status',
			array(
				array(
					'methods'             => WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'update_status' ),
					'permission_callback' => array( $this, 'check_settings_permission' ),
					'args'                => array(
						'attachment_id' => array(
							'required'          => true,
							'type'              => 'integer',
							'sanitize_callback' => 'absint',
						),
						'status' => array(
							'required'          => true,
							'type'              => 'string',
							'enum'              => array( 'pending', 'processing', 'processed', 'approved', 'failed' ),
							'sanitize_callback' => 'sanitize_text_field',
						),
					),
				),
			)
		);

		// Settings.
		register_rest_route(
			$this->namespace,
			'/settings',
			array(
				array(
					'methods'             => WP_REST_Server::READABLE,
					'callback'            => array( $this, 'get_settings' ),
					'permission_callback' => array( $this, 'check_settings_permission' ),
				),
				array(
					'methods'             => WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'update_settings' ),
					'permission_callback' => array( $this, 'check_settings_permission' ),
				),
			)
		);
	}

	/**
	 * Analyze images.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response|WP_Error Response object.
	 */
	public function analyze_images( WP_REST_Request $request ) {
		$attachment_ids = $request->get_param( 'attachment_ids' );
		$language       = $request->get_param( 'language' ) ?: $this->language_detector->get_current_language();

		if ( empty( $attachment_ids ) || ! is_array( $attachment_ids ) ) {
			return new WP_Error(
				'invalid_params',
				__( 'Attachment IDs are required.', 'ai-media-seo' ),
				array( 'status' => 400 )
			);
		}

		// Get provider configuration.
		$providers = get_option( 'ai_media_seo_providers', array() );

		if ( empty( $providers['openai']['api_key'] ) ) {
			return new WP_Error(
				'provider_not_configured',
				__( 'OpenAI provider is not configured.', 'ai-media-seo' ),
				array( 'status' => 400 )
			);
		}

		// Initialize provider.
		$provider = new OpenAIProvider( $providers['openai'] );

		// Initialize analyzer.
		$analyzer = new ImageAnalyzer();

		$results = array();
		$errors = array();

		foreach ( $attachment_ids as $attachment_id ) {
			// Set status to processing.
			update_post_meta( $attachment_id, '_ai_media_status', 'processing' );

			try {
				$result = $analyzer->process(
					(int) $attachment_id,
					$language,
					$provider,
					array( 'auto_apply' => true )
				);

				if ( $result['success'] ) {
					// Apply metadata to WordPress if auto-approved.
					if ( $result['can_auto_approve'] && isset( $result['metadata'] ) ) {
						$this->apply_metadata_to_attachment( $attachment_id, $result['metadata'], $language );
						// Set status to approved.
						update_post_meta( $attachment_id, '_ai_media_status', 'approved' );
					} else {
						// Set status to processed (needs review).
						update_post_meta( $attachment_id, '_ai_media_status', 'processed' );
					}

					$results[] = array(
						'attachment_id' => $attachment_id,
						'job_id'        => $result['job_id'],
						'status'        => $result['can_auto_approve'] ? 'approved' : 'processed',
						'score'         => $result['final_score'],
						'metadata'      => $result['metadata'],
					);
				} else {
					// Set status to failed.
					update_post_meta( $attachment_id, '_ai_media_status', 'failed' );
					$errors[] = array(
						'attachment_id' => $attachment_id,
						'errors'        => $result['errors'],
					);
				}
			} catch ( \Exception $e ) {
				// Set status to failed.
				update_post_meta( $attachment_id, '_ai_media_status', 'failed' );
				$errors[] = array(
					'attachment_id' => $attachment_id,
					'errors'        => array( $e->getMessage() ),
				);
			}
		}

		return new WP_REST_Response(
			array(
				'success' => ! empty( $results ),
				'results' => $results,
				'errors'  => $errors,
				'total'   => count( $attachment_ids ),
				'processed' => count( $results ),
				'failed'  => count( $errors ),
			),
			200
		);
	}

	/**
	 * Approve metadata.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response|WP_Error Response object.
	 */
	public function approve_metadata( WP_REST_Request $request ) {
		$job_id = $request->get_param( 'job_id' );
		$fields = $request->get_param( 'fields' ) ?: array();

		if ( empty( $job_id ) ) {
			return new WP_Error(
				'invalid_params',
				__( 'Job ID is required.', 'ai-media-seo' ),
				array( 'status' => 400 )
			);
		}

		$success = $this->metadata_store->approve_job( (int) $job_id, $fields );

		if ( $success ) {
			return new WP_REST_Response(
				array(
					'success' => true,
					'message' => __( 'Metadata approved and applied.', 'ai-media-seo' ),
				),
				200
			);
		} else {
			return new WP_Error(
				'approval_failed',
				__( 'Failed to approve metadata.', 'ai-media-seo' ),
				array( 'status' => 500 )
			);
		}
	}

	/**
	 * Get jobs.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response Response object.
	 */
	public function get_jobs( WP_REST_Request $request ) {
		global $wpdb;

		$table_name = $wpdb->prefix . 'ai_media_jobs';

		$status = $request->get_param( 'status' );
		$language = $request->get_param( 'language' );
		$page = max( 1, (int) $request->get_param( 'page' ) );
		$per_page = min( 100, max( 1, (int) $request->get_param( 'per_page' ) ) );

		$offset = ( $page - 1 ) * $per_page;

		$where = array( '1=1' );
		$values = array();

		if ( ! empty( $status ) ) {
			$where[] = 'status = %s';
			$values[] = $status;
		}

		if ( ! empty( $language ) ) {
			$where[] = 'language_code = %s';
			$values[] = $language;
		}

		$where_clause = implode( ' AND ', $where );

		// Get total count.
		$total = $wpdb->get_var(
			empty( $values )
				? "SELECT COUNT(*) FROM {$table_name} WHERE {$where_clause}"
				: $wpdb->prepare( "SELECT COUNT(*) FROM {$table_name} WHERE {$where_clause}", $values )
		);

		// Get jobs.
		$query_values = array_merge( $values, array( $per_page, $offset ) );

		$jobs = $wpdb->get_results(
			$wpdb->prepare(
				"SELECT * FROM {$table_name}
				WHERE {$where_clause}
				ORDER BY created_at DESC
				LIMIT %d OFFSET %d",
				$query_values
			),
			ARRAY_A
		);

		// Decode JSON fields.
		foreach ( $jobs as &$job ) {
			if ( ! empty( $job['request_data'] ) ) {
				$job['request_data'] = json_decode( $job['request_data'], true );
			}

			if ( ! empty( $job['response_data'] ) ) {
				$job['response_data'] = json_decode( $job['response_data'], true );
			}
		}

		return new WP_REST_Response(
			array(
				'jobs'       => $jobs,
				'pagination' => array(
					'total'     => (int) $total,
					'page'      => $page,
					'per_page'  => $per_page,
					'total_pages' => ceil( $total / $per_page ),
				),
			),
			200
		);
	}

	/**
	 * Get statistics.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response Response object.
	 */
	public function get_stats( WP_REST_Request $request ) {
		$stats = array(
			'today' => $this->metadata_store->get_stats( 'today' ),
			'week'  => $this->metadata_store->get_stats( 'week' ),
			'month' => $this->metadata_store->get_stats( 'month' ),
			'all'   => $this->metadata_store->get_stats( 'all' ),
		);

		return new WP_REST_Response( $stats, 200 );
	}

	/**
	 * Regenerate metadata.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response|WP_Error Response object.
	 */
	public function regenerate_metadata( WP_REST_Request $request ) {
		$attachment_id    = $request->get_param( 'attachment_id' );
		$language         = $request->get_param( 'language' ) ?: $this->language_detector->get_current_language();
		$context_override = $request->get_param( 'context_override' ) ?: array();

		if ( empty( $attachment_id ) ) {
			return new WP_Error(
				'invalid_params',
				__( 'Attachment ID is required.', 'ai-media-seo' ),
				array( 'status' => 400 )
			);
		}

		// Get provider.
		$providers = get_option( 'ai_media_seo_providers', array() );

		if ( empty( $providers['openai']['api_key'] ) ) {
			return new WP_Error(
				'provider_not_configured',
				__( 'OpenAI provider is not configured.', 'ai-media-seo' ),
				array( 'status' => 400 )
			);
		}

		$provider = new OpenAIProvider( $providers['openai'] );
		$analyzer = new ImageAnalyzer();

		try {
			$result = $analyzer->process(
				(int) $attachment_id,
				$language,
				$provider,
				array(
					'context_override' => $context_override,
					'auto_apply'       => false,
				)
			);

			if ( $result['success'] ) {
				return new WP_REST_Response(
					array(
						'success'  => true,
						'job_id'   => $result['job_id'],
						'metadata' => $result['metadata'],
						'score'    => $result['final_score'],
					),
					200
				);
			} else {
				return new WP_Error(
					'regeneration_failed',
					$result['errors'][0] ?? __( 'Failed to regenerate metadata.', 'ai-media-seo' ),
					array( 'status' => 500 )
				);
			}
		} catch ( \Exception $e ) {
			return new WP_Error(
				'regeneration_error',
				$e->getMessage(),
				array( 'status' => 500 )
			);
		}
	}

	/**
	 * Check analyze permission.
	 *
	 * @since 1.0.0
	 * @return bool True if user has permission.
	 */
	public function check_analyze_permission(): bool {
		return current_user_can( 'ai_media_process_images' );
	}

	/**
	 * Check approve permission.
	 *
	 * @since 1.0.0
	 * @return bool True if user has permission.
	 */
	public function check_approve_permission(): bool {
		return current_user_can( 'ai_media_approve_metadata' );
	}

	/**
	 * Check read permission.
	 *
	 * @since 1.0.0
	 * @return bool True if user has permission.
	 */
	public function check_read_permission(): bool {
		return current_user_can( 'ai_media_process_images' );
	}

	/**
	 * Get analyze endpoint arguments.
	 *
	 * @since 1.0.0
	 * @return array Arguments schema.
	 */
	private function get_analyze_args(): array {
		return array(
			'attachment_ids' => array(
				'required'          => true,
				'type'              => 'array',
				'items'             => array( 'type' => 'integer' ),
				'sanitize_callback' => function( $value ) {
					return array_map( 'intval', (array) $value );
				},
			),
			'language' => array(
				'required'          => false,
				'type'              => 'string',
				'default'           => $this->language_detector->get_current_language(),
				'sanitize_callback' => 'sanitize_text_field',
				'validate_callback' => function( $value ) {
					return $this->language_detector->is_valid_language( $value );
				},
			),
		);
	}

	/**
	 * Get approve endpoint arguments.
	 *
	 * @since 1.0.0
	 * @return array Arguments schema.
	 */
	private function get_approve_args(): array {
		return array(
			'job_id' => array(
				'required'          => true,
				'type'              => 'integer',
				'sanitize_callback' => 'absint',
			),
			'fields' => array(
				'required'          => false,
				'type'              => 'array',
				'items'             => array( 'type' => 'string' ),
				'default'           => array(),
				'sanitize_callback' => function( $value ) {
					return array_map( 'sanitize_text_field', (array) $value );
				},
			),
		);
	}

	/**
	 * Get jobs endpoint arguments.
	 *
	 * @since 1.0.0
	 * @return array Arguments schema.
	 */
	private function get_jobs_args(): array {
		return array(
			'status' => array(
				'required'          => false,
				'type'              => 'string',
				'sanitize_callback' => 'sanitize_text_field',
			),
			'language' => array(
				'required'          => false,
				'type'              => 'string',
				'sanitize_callback' => 'sanitize_text_field',
			),
			'page' => array(
				'required'          => false,
				'type'              => 'integer',
				'default'           => 1,
				'sanitize_callback' => 'absint',
			),
			'per_page' => array(
				'required'          => false,
				'type'              => 'integer',
				'default'           => 50,
				'sanitize_callback' => 'absint',
			),
		);
	}

	/**
	 * Get regenerate endpoint arguments.
	 *
	 * @since 1.0.0
	 * @return array Arguments schema.
	 */
	private function get_regenerate_args(): array {
		return array(
			'attachment_id' => array(
				'required'          => true,
				'type'              => 'integer',
				'sanitize_callback' => 'absint',
			),
			'language' => array(
				'required'          => false,
				'type'              => 'string',
				'default'           => $this->language_detector->get_current_language(),
				'sanitize_callback' => 'sanitize_text_field',
				'validate_callback' => function( $value ) {
					return $this->language_detector->is_valid_language( $value );
				},
			),
			'context_override' => array(
				'required' => false,
				'type'     => 'object',
				'default'  => array(),
			),
		);
	}

	/**
	 * Get settings.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response Response object.
	 */
	public function get_settings( WP_REST_Request $request ): WP_REST_Response {
		return new WP_REST_Response(
			array(
				'settings'      => get_option( 'ai_media_seo_settings', array() ),
				'providers'     => get_option( 'ai_media_seo_providers', array() ),
				'quality_rules' => get_option( 'ai_media_seo_quality_rules', array() ),
			),
			200
		);
	}

	/**
	 * Update settings.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response|WP_Error Response object.
	 */
	public function update_settings( WP_REST_Request $request ) {
		$settings      = $request->get_param( 'settings' );
		$providers     = $request->get_param( 'providers' );
		$quality_rules = $request->get_param( 'quality_rules' );

		$updated = array();

		if ( null !== $settings ) {
			$sanitized = $this->sanitize_settings( $settings );
			update_option( 'ai_media_seo_settings', $sanitized );
			$updated['settings'] = $sanitized;
		}

		if ( null !== $providers ) {
			$sanitized = $this->sanitize_providers( $providers );
			update_option( 'ai_media_seo_providers', $sanitized );
			$updated['providers'] = $sanitized;
		}

		if ( null !== $quality_rules ) {
			$sanitized = $this->sanitize_quality_rules( $quality_rules );
			update_option( 'ai_media_seo_quality_rules', $sanitized );
			$updated['quality_rules'] = $sanitized;
		}

		return new WP_REST_Response(
			array(
				'success' => true,
				'message' => __( 'Settings updated successfully.', 'ai-media-seo' ),
				'updated' => $updated,
			),
			200
		);
	}

	/**
	 * Check settings permission.
	 *
	 * @since 1.0.0
	 * @return bool True if user has permission.
	 */
	public function check_settings_permission(): bool {
		return current_user_can( 'manage_options' );
	}

	/**
	 * Sanitize settings.
	 *
	 * @since 1.0.0
	 * @param array $input Raw settings input.
	 * @return array Sanitized settings.
	 */
	private function sanitize_settings( $input ): array {
		$sanitized = array();

		if ( isset( $input['lite_daily_limit'] ) ) {
			$sanitized['lite_daily_limit'] = absint( $input['lite_daily_limit'] );
		}

		if ( isset( $input['batch_size'] ) ) {
			$sanitized['batch_size'] = absint( $input['batch_size'] );
		}

		if ( isset( $input['max_concurrent'] ) ) {
			$sanitized['max_concurrent'] = absint( $input['max_concurrent'] );
		}

		if ( isset( $input['rate_limit_rpm'] ) ) {
			$sanitized['rate_limit_rpm'] = absint( $input['rate_limit_rpm'] );
		}

		if ( isset( $input['auto_approve_threshold'] ) ) {
			$sanitized['auto_approve_threshold'] = floatval( $input['auto_approve_threshold'] );
		}

		if ( isset( $input['max_image_size'] ) ) {
			$sanitized['max_image_size'] = absint( $input['max_image_size'] );
		}

		if ( isset( $input['enable_auto_process'] ) ) {
			$sanitized['enable_auto_process'] = (bool) $input['enable_auto_process'];
		}

		if ( isset( $input['primary_language'] ) ) {
			$sanitized['primary_language'] = sanitize_text_field( $input['primary_language'] );
		}

		return $sanitized;
	}

	/**
	 * Sanitize provider settings.
	 *
	 * @since 1.0.0
	 * @param array $input Raw provider settings.
	 * @return array Sanitized provider settings.
	 */
	private function sanitize_providers( $input ): array {
		$sanitized = array();

		foreach ( array( 'openai', 'anthropic', 'google' ) as $provider ) {
			if ( ! isset( $input[ $provider ] ) ) {
				continue;
			}

			$sanitized[ $provider ] = array();

			if ( isset( $input[ $provider ]['api_key'] ) ) {
				$sanitized[ $provider ]['api_key'] = sanitize_text_field( $input[ $provider ]['api_key'] );
			}

			if ( isset( $input[ $provider ]['model'] ) ) {
				$sanitized[ $provider ]['model'] = sanitize_text_field( $input[ $provider ]['model'] );
			}

			if ( isset( $input[ $provider ]['enabled'] ) ) {
				$sanitized[ $provider ]['enabled'] = (bool) $input[ $provider ]['enabled'];
			}
		}

		return $sanitized;
	}

	/**
	 * Sanitize quality rules.
	 *
	 * @since 1.0.0
	 * @param array $input Raw quality rules.
	 * @return array Sanitized quality rules.
	 */
	private function sanitize_quality_rules( $input ): array {
		$sanitized = array();

		if ( isset( $input['forbidden_alt_phrases'] ) && is_array( $input['forbidden_alt_phrases'] ) ) {
			$sanitized['forbidden_alt_phrases'] = array_map( 'sanitize_text_field', $input['forbidden_alt_phrases'] );
		}

		if ( isset( $input['require_descriptive'] ) ) {
			$sanitized['require_descriptive'] = (bool) $input['require_descriptive'];
		}

		if ( isset( $input['min_score'] ) ) {
			$sanitized['min_score'] = floatval( $input['min_score'] );
		}

		return $sanitized;
	}

	/**
	 * Batch analyze images.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response|WP_Error Response object.
	 */
	public function batch_analyze( WP_REST_Request $request ) {
		$mode       = $request->get_param( 'mode' ) ?: 'selected';
		$ids        = $request->get_param( 'attachment_ids' ) ?: array();
		$language   = $request->get_param( 'language' ) ?: $this->language_detector->get_current_language();

		$attachment_ids = array();

		switch ( $mode ) {
			case 'selected':
				if ( empty( $ids ) || ! is_array( $ids ) ) {
					return new WP_Error(
						'invalid_params',
						__( 'Attachment IDs are required for selected mode.', 'ai-media-seo' ),
						array( 'status' => 400 )
					);
				}
				$attachment_ids = array_map( 'absint', $ids );
				break;

			case 'missing_metadata':
				// Get all images without ALT text or caption.
				$attachment_ids = $this->get_attachments_missing_metadata();
				break;

			case 'all':
				// Get all images.
				$attachment_ids = $this->get_all_image_attachments();
				break;

			default:
				return new WP_Error(
					'invalid_mode',
					__( 'Invalid batch mode. Use: selected, missing_metadata, or all.', 'ai-media-seo' ),
					array( 'status' => 400 )
				);
		}

		if ( empty( $attachment_ids ) ) {
			return new WP_REST_Response(
				array(
					'success' => false,
					'message' => __( 'No images found to process.', 'ai-media-seo' ),
					'queued'  => 0,
				),
				200
			);
		}

		// Use Queue Manager to enqueue batch.
		$queue_manager = new \AIMediaSEO\Queue\QueueManager();
		$batch_info    = $queue_manager->enqueue_batch( $attachment_ids, $language, array() );

		return new WP_REST_Response(
			array(
				'success'  => true,
				'message'  => sprintf(
					/* translators: %d: number of images queued */
					__( '%d images queued for analysis.', 'ai-media-seo' ),
					$batch_info['total']
				),
				'batch_id' => $batch_info['batch_id'],
				'queued'   => $batch_info['total'],
				'chunks'   => $batch_info['chunks'],
				'mode'     => $mode,
			),
			200
		);
	}

	/**
	 * Update image status.
	 *
	 * @since 1.0.0
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response|WP_Error Response object or error.
	 */
	public function update_status( WP_REST_Request $request ) {
		$attachment_id = $request->get_param( 'attachment_id' );
		$status        = $request->get_param( 'status' );

		// Validate attachment exists and is an image.
		$attachment = get_post( $attachment_id );
		if ( ! $attachment || 'attachment' !== $attachment->post_type ) {
			return new WP_Error(
				'invalid_attachment',
				__( 'Invalid attachment ID.', 'ai-media-seo' ),
				array( 'status' => 404 )
			);
		}

		// Update status.
		update_post_meta( $attachment_id, '_ai_media_status', $status );

		return new WP_REST_Response(
			array(
				'success' => true,
				'message' => __( 'Status updated successfully.', 'ai-media-seo' ),
				'status'  => $status,
			),
			200
		);
	}

	/**
	 * Get attachments missing metadata.
	 *
	 * @since 1.0.0
	 * @return array Array of attachment IDs.
	 */
	private function get_attachments_missing_metadata(): array {
		global $wpdb;

		$query = "
			SELECT p.ID
			FROM {$wpdb->posts} p
			WHERE p.post_type = 'attachment'
			AND p.post_mime_type LIKE 'image/%'
			AND (
				NOT EXISTS (
					SELECT 1 FROM {$wpdb->postmeta} pm
					WHERE pm.post_id = p.ID
					AND pm.meta_key = '_wp_attachment_image_alt'
					AND pm.meta_value != ''
				)
				OR NOT EXISTS (
					SELECT 1 FROM {$wpdb->posts} pc
					WHERE pc.ID = p.ID
					AND pc.post_excerpt != ''
				)
			)
			ORDER BY p.post_date DESC
		";

		return array_map( 'intval', $wpdb->get_col( $query ) );
	}

	/**
	 * Get all image attachments.
	 *
	 * @since 1.0.0
	 * @return array Array of attachment IDs.
	 */
	private function get_all_image_attachments(): array {
		$args = array(
			'post_type'      => 'attachment',
			'post_mime_type' => 'image',
			'post_status'    => 'inherit',
			'posts_per_page' => -1,
			'fields'         => 'ids',
			'orderby'        => 'date',
			'order'          => 'DESC',
		);

		return get_posts( $args );
	}

	/**
	 * Get batch analyze endpoint arguments.
	 *
	 * @since 1.0.0
	 * @return array Arguments schema.
	 */
	private function get_batch_analyze_args(): array {
		return array(
			'mode' => array(
				'required'          => false,
				'type'              => 'string',
				'default'           => 'selected',
				'enum'              => array( 'selected', 'missing_metadata', 'all' ),
				'sanitize_callback' => 'sanitize_text_field',
			),
			'attachment_ids' => array(
				'required' => false,
				'type'     => 'array',
				'default'  => array(),
				'items'    => array(
					'type' => 'integer',
				),
			),
			'language' => array(
				'required'          => false,
				'type'              => 'string',
				'default'           => $this->language_detector->get_current_language(),
				'sanitize_callback' => 'sanitize_text_field',
			),
		);
	}

	/**
	 * Apply metadata to attachment.
	 *
	 * @since 1.0.0
	 * @param int    $attachment_id Attachment ID.
	 * @param array  $metadata      Metadata to apply.
	 * @param string $language      Language code.
	 */
	private function apply_metadata_to_attachment( int $attachment_id, array $metadata, string $language ) {
		// Update ALT text.
		if ( ! empty( $metadata['alt'] ) ) {
			if ( $this->language_detector->is_multilingual_active() ) {
				// Multilingual: store with language suffix.
				update_post_meta( $attachment_id, '_wp_attachment_image_alt_' . $language, $metadata['alt'] );
			} else {
				// Standard: update ALT text.
				update_post_meta( $attachment_id, '_wp_attachment_image_alt', $metadata['alt'] );
			}
		}

		// Update caption (post_excerpt).
		if ( ! empty( $metadata['caption'] ) ) {
			$update_data = array(
				'ID'           => $attachment_id,
				'post_excerpt' => $metadata['caption'],
			);
			wp_update_post( $update_data );
		}

		// Update title (post_title).
		if ( ! empty( $metadata['title'] ) ) {
			$update_data = array(
				'ID'         => $attachment_id,
				'post_title' => $metadata['title'],
			);
			wp_update_post( $update_data );
		}

		// Update keywords as taxonomy or meta.
		if ( ! empty( $metadata['keywords'] ) && is_array( $metadata['keywords'] ) ) {
			// Store as comma-separated meta for now.
			update_post_meta( $attachment_id, '_ai_media_keywords_' . $language, implode( ', ', $metadata['keywords'] ) );
		}

		// Store AI score.
		if ( isset( $metadata['score'] ) ) {
			update_post_meta( $attachment_id, '_ai_media_score_' . $language, $metadata['score'] );
		}
	}
}
